<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GAJ_SellShips" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:noNamespaceSchemaLocation="../../xsd/md.xsd">
  <cues>
    <cue name="Sell" namespace="this" version="1">
      <conditions>
        <check_any>
          <event_game_loaded />
          <event_game_started />
          <event_player_created />
          <event_cue_signalled cue="md.Setup.Start" />
        </check_any>
      </conditions>
      <actions>
        <!-- Settings -->
        <!-- ships sold direct to ai sell for % of average price -->
        <set_value name="$UsedMult" exact="table[
            $dock_xxl = 0.5,
            $dock_dxxl = 0.5,
            $dock_xl = 0.5,
            $dock_l = 0.5,
            $dock_l_mandator_2 = 0.5,
            $dock_l_mandatoriii = 0.5,
            $dock_m = 0.5,
            $dock_s = 0.5,
            $dock_xs = 0.5
          ]"
        />
        <!-- Pirates pay less but no risk when selling stolen ships -->
        <set_value name="$PirateMult" exact="0.8" />
        <set_value name="global.$GAJ_SellShips" exact="this" />
        <create_group groupname="Sell.$SellShipsGroup" />
        <set_value name="Sell.$SellShips" exact="table[]" />
      </actions>
      <cues>
        <!-- ui interaction button -->
        <cue name="SellShips_Button">
          <conditions>
            <event_cue_signalled cue="md.Interact_Menu_API.Get_Actions" />
            <check_value value="@event.param.$object.isoperational" />
            <check_any>
              <check_value value="@event.param.$object.isshipyard" />
              <check_value value="@event.param.$object.iswharf" />
            </check_any>
            <check_value value="not event.param.$object.isplayerowned" />
            <check_value value="@event.param.$selectedplayerships.count ge 1" />
          </conditions>
          <actions>
            <set_value name="$interact_ships" exact="event.param.$selectedplayerships" />
            <set_value name="$Interact_target" exact="event.param.$object" />

            <!-- limit ships to same sector -->
            <!-- <do_for_each name="$ship" in="$interact_ships" reverse="true">
              <do_if value="$ship.sector != $Interact_target.sector">
                <remove_from_list name="$interact_ships" exact="$ship" />
              </do_if>
            </do_for_each> -->

            <!-- determine station's building compatabilities -->
            <set_value name="$dockSizes" exact="[]" />
            <!-- xl valid -->
            <find_object_component name="$xl" object="$Interact_target" class="class.buildmodule" multiple="true">
              <match canbuildclass="class.ship_xl" />
            </find_object_component>
            <do_if value="$xl.count gt 0">
              <append_to_list name="$dockSizes" exact="'dock_xl'" />
              <!-- xxl valid -->
              <do_for_each name="$module" in="$xl">
                <do_if value="$module.dock.{tag.dock_xxl}">
                  <debug_text text="'can build xxl'" chance="global.$GettingAJob_Work.$Debug" />
                  <append_to_list name="$dockSizes" exact="'dock_xxl'" />
                </do_if>
              </do_for_each>
              <!-- dxxl valid -->
              <do_for_each name="$module" in="$xl">
                <do_if value="$module.dock.{tag.dock_dxxl}">
                  <debug_text text="'can build dxxl'" chance="global.$GettingAJob_Work.$Debug" />
                  <append_to_list name="$dockSizes" exact="'dock_dxxl'" />
                </do_if>
              </do_for_each>
              <debug_text text="'can build xl'" chance="global.$GettingAJob_Work.$Debug" />
            </do_if>
            <!-- l valid -->
            <find_object_component name="$l" object="$Interact_target" class="class.buildmodule">
              <match canbuildclass="class.ship_l" />
            </find_object_component>
            <do_if value="$l">
              <debug_text text="'can build l'" chance="global.$GettingAJob_Work.$Debug" />
              <append_to_list name="$dockSizes" exact="'dock_l'" />
              <append_to_list name="$dockSizes" exact="'dock_l_mandator_2'" />
              <append_to_list name="$dockSizes" exact="'dock_l_mandatoriii'" />
            </do_if>
            <!-- m valid -->
            <find_object_component name="$m" object="$Interact_target" class="class.buildmodule">
              <match canbuildclass="class.ship_m" />
            </find_object_component>
            <do_if value="$m">
              <debug_text text="'can build m'" chance="global.$GettingAJob_Work.$Debug" />
              <append_to_list name="$dockSizes" exact="'dock_m'" />
            </do_if>
            <!-- s valid -->
            <find_object_component name="$s" object="$Interact_target" class="class.buildmodule">
              <match canbuildclass="class.ship_s" />
            </find_object_component>
            <do_if value="$s">
              <debug_text text="'can build s'" chance="global.$GettingAJob_Work.$Debug" />
              <append_to_list name="$dockSizes" exact="'dock_s'" />
            </do_if>
            <do_if value="$dockSizes?">
              <set_value name="$display" exact="false" />
              <!-- display interaction when any selected ship is compatible with station and in same sector as station -->
              <do_for_each name="$ship" in="$interact_ships">
                <do_if value="$dockSizes.indexof.{''+$ship.docksize}">
                  <set_value name="$display" exact="true" />
                  <break />
                </do_if>
              </do_for_each>
              <do_if value="$display">
                <signal_cue_instantly cue="md.Interact_Menu_API.Add_Action" param="table[
                  $id = 'sellships',
                  $section = 'selected_orders',
                  $text = 'SellShips',
                  $icon = 'menu_swi_credits',
                  $callback = SellShips_Menu,
                  $echo = table[$dockSizes = $dockSizes]
                ]" />
              </do_if>
            </do_if>
            <reset_cue cue="this" />
          </actions>
        </cue>

        <!-- Sell Ships Menu -->
        <cue name="SellShips_Menu" instantiate="true">
          <conditions>
            <event_cue_signalled />
          </conditions>
          <delay exact="1ms" />
          <actions>
            <!-- cue variables -->
            <set_value name="$ValidShips" exact="table[]" />
            <set_value name="$SellTotal" exact="0" />
            <set_value name="$Interact_target" exact="@event.param.$object" />

            <!-- create valid sell list -->
            <set_value name="$interact_ships" exact="@event.param.$selectedplayerships" />
            <set_value name="$dockSizes" exact="@event.param.$echo.$dockSizes" />
            <!-- <set_value name="$stationMult" exact="if $Interact_target.ispiratebase then $PirateFactor else 1" /> -->
            <do_for_each name="$ship" in="$interact_ships">
              <!-- <do_if value="$ship.isclass.ship and $ship.sector == $Interact_target.sector"> -->
              <do_if value="$ship.isclass.ship">
                <set_value name="$docksize" exact="$ship.docksize" />
                <do_if value="$dockSizes.indexof.{''+$docksize}">
                  <set_value name="$ValidShips.{$ship}" exact="table[]" />
                  <!-- reduce price for selling a used ship by % value based on its docksize requirement and if sold to pirates -->
                  <get_object_value result="$price" object="$ship" pricetable="$Interact_target.buildbuyprices" />
                  <!-- <set_value name="$price" exact="$price * $UsedMult.{'$'+$docksize} * $stationMult * $ship.hullpercentage" /> -->
                  <set_value name="$ValidShips.{$ship}.$price" exact="$price" />
                  <set_value name="$ValidShips.{$ship}.$sell" exact="true" />
                  <set_value name="$SellTotal" operation="add" exact="$price" />
                  <set_value name="$ValidShips.{$ship}.$sector" exact="false" />
                  <do_if value="$ship.sector == $Interact_target.sector">
                    <set_value name="$ValidShips.{$ship}.$sector" exact="true" />
                  </do_if>
                </do_if>
              </do_if>
            </do_for_each>
            <signal_cue cue="SellShips_Menu_Open" />
          </actions>
          <cues>
            <cue name="SellShips_Menu_Open" instantiate="true">
              <conditions>
                <event_cue_signalled />
              </conditions>
              <delay exact="1ms" />
              <actions>
                <signal_cue_instantly cue="md.Simple_Menu_API.Create_Menu" param="table[
                  $id = 'sell_menu',
                  $columns = 2,
                  $title = 'Sellable Ships',
                  $height = 400,
                  $width = 495
                ]" />
                <signal_cue_instantly cue="md.Simple_Menu_API.Call_Table_Method" param="table[$method='setColWidth', $col=1, $width=374]" />
                <signal_cue_instantly cue="md.Simple_Menu_API.Call_Table_Method" param="table[$method='setColWidth', $col=2, $width=119]" />
                <do_for_each name="$ship" in="$ValidShips.keys.list">
                  <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row" param="table[]" />
                  <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
                    $col=1,
                    $halign = 'right',
                    $text=$ship.name+': %,s'.[$ValidShips.{$ship}.$price]
                  ]" />
                  <signal_cue_instantly cue="md.Simple_Menu_API.Make_CheckBox" param="table[
                      $id = $ship,
                      $checked = $ValidShips.{$ship}.$sell,
                      $col = 2,
                      $width = 20,
                      $text = table[$text=''],
                      $onClick = CheckClicked
                    ]" />
                </do_for_each>
                <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row" param="table[]" />
                <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[$text='']" />
                <signal_cue_instantly cue="md.Simple_Menu_API.Add_Row" param="table[]" />
                <signal_cue_instantly cue="md.Simple_Menu_API.Make_Text" param="table[
                  $col=1,
                  $halign='right',
                  $text='Total: %,s'.[$SellTotal]
                ]" />
                <signal_cue_instantly cue="md.Simple_Menu_API.Make_Button" param="table[
                  $col = 2,
                  $width=100,
                  $text = table[$text='Confirm'],
                  $mouseOverText = table[$text='Funds paid when ship is delivered.'],
                  $onClick = ConfirmSell
                ]" />
              </actions>
            </cue>
            <cue name="CheckClicked" instantiate="true">
              <conditions>
                <event_cue_signalled />
              </conditions>
              <delay exact="1ms" />
              <actions>
                <set_value name="$ship" exact="event.param.$id" />
                <set_value name="$ValidShips.{$ship}.$sell" exact="event.param.$checked" />
                <do_if value="event.param.$checked">
                  <set_value name="$SellTotal" operation="add" exact="$ValidShips.{$ship}.$price" />
                </do_if>
                <do_else>
                  <set_value name="$SellTotal" operation="subtract" exact="$ValidShips.{$ship}.$price" />
                </do_else>
                <signal_cue_instantly cue="md.Simple_Menu_API.Close_Menu" />
                <signal_cue_instantly cue="SellShips_Menu_Open" />
              </actions>
            </cue>
            <cue name="ConfirmSell" instantiate="true">
              <conditions>
                <event_cue_signalled />
              </conditions>
              <delay exact="1ms" />
              <actions>
                <do_for_each name="$ship" in="$ValidShips.keys.list">
                  <do_if value="$ValidShips.{$ship}.$sell">
                    <remove_object_commander object="$ship" />
                    <cancel_all_orders object="$ship" />
                    <create_order object="$ship" id="SellShips_MoveSell">
                      <param name="station" value="$Interact_target" />
                    </create_order>
                    <add_to_group groupname="$SellShipsGroup" object="$ship" />
                    <set_value name="$SellShips.{$ship}" exact="table[
                      $station = $Interact_target,
                      $destination = $Interact_target.sector,
                      $price = $ValidShips.{$ship}.$price]
                    " />
                  </do_if>
                </do_for_each>
                <signal_cue_instantly cue="md.Simple_Menu_API.Close_Menu" />
              </actions>
            </cue>
          </cues>
        </cue>
        <cue name="Sold" instantiate="true">
          <conditions>
            <event_object_changed_sector group="$SellShipsGroup" />
            <check_value value="$SellShips.{event.object}.$destination == event.param" />
          </conditions>
          <actions>
            <set_value name="$ship" exact="event.object" />
            <set_value name="$data" exact="$SellShips.{$ship}" />
            <!-- todo: add stolen ship checks. if ship stolen from enemy, then ok, otherwise: crime and forfeiture of ship and fines deducted from $SellTotal -->
            <signal_cue_instantly cue="md.GalacticBankRC3.Transfer" param="table[$faction = $data.$station.owner, $money = ($data.$price)Cr]" />
            <remove_from_group group="$SellShipsGroup" object="$ship" />
            <remove_value name="$SellShips.{$ship}" />
          </actions>
        </cue>
      </cues>
    </cue>

    <cue name="OnLuaLoaderReady">
      <conditions>
        <event_ui_triggered screen="'Lua_Loader'" control="'Ready'" />
      </conditions>
      <actions>
        <raise_lua_event name="'Lua_Loader.Load'" param="'extensions.kuertee_ui_extensions.ui.kuertee_menu_interactmenu'" />
      </actions>
    </cue>
    <cue name="OnLuaLoaderReadyCompleted">
      <conditions>
        <event_cue_completed cue="OnLuaLoaderReady" />
      </conditions>
      <actions>
        <reset_cue cue="OnLuaLoaderReady" />
        <reset_cue cue="this" />
      </actions>
    </cue>
  </cues>
</mdscript>
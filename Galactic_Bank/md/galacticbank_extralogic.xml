<?xml version="1.0" encoding="utf-8"?>
<mdscript name="GalacticBankTest2_ExtraLogic" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:noNamespaceSchemaLocation="../../xsd/md.xsd">
	<cues>
		<cue name="Why" namespace="this">
			<conditions>
				<check_any>
					<event_game_loaded />
					<event_game_started />
					<event_player_created />
					<event_cue_signalled cue="md.Setup.Start" />
				</check_any>
				<check_value value="not @player.allmodules.{player.module}.isscenario" />
			</conditions>
			<actions>

				<!--
          Vault.global.$GB_Vault.$Accounts.{$faction} = table[
						$balance = (int)ct,
						$loan_ammount = float,
						$interest_time = time,
						$collateral = [ships]
						$closed = bool,
						$relation = float,
						$inheritanceTax = float,

						- Lists -
						$fee = [float],
						$undockedFee = [float],
						$rate = [float],
						$period = [time],
						$loan_rate = [float],
						$loan_collateral_rate = [float],
					]
        -->
			</actions>
			<cues>
				<cue name="BankTransports" instantiate="true">
					<conditions>
						<check_any>
							<event_job_ship_activated />
							<event_object_destroyed group="global.$GB_Vault.$BankTransports" />
						</check_any>
					</conditions>
					<actions>
						<do_if value="event.name == 'event_job_ship_activated'">
							<add_to_group groupname="global.$GB_Vault.$BankTransports" object="event.param" />
						</do_if>
						<do_elseif value="event.name == 'event_object_destroyed'">
							<remove_from_group group="global.$GB_Vault.$BankTransports" object="event.object" />
							<do_if value="event.param.trueowner == faction.player">
								<add_faction_relation faction="faction.bankingclan" otherfaction="faction.player" value="-0.01" reason="relationchangereason.killedobject" />
							</do_if>
						</do_elseif>
					</actions>
				</cue>

				<cue name="LootboxFinder" instantiate="true">
					<conditions>
						<event_object_dropped_objects group="global.$GB_Vault.$BankTransports" />
					</conditions>
					<actions>
						<do_if value="not event.object.exists">
							<remove_from_group group="global.$GB_Vault.$BankTransports" object="event.object" />
						</do_if>
						<do_for_each name="$drop" in="event.param">
							<do_if value="$drop == ware.bank_large_lootbox or $drop == ware.inv_bank_lootbox">
								<set_drop_persistence object="$drop" />
								<set_value name="global.$GB_Vault.$LootboxDrops.{$drop}" exact="player.age" />
							</do_if>
						</do_for_each>
					</actions>
				</cue>

				<cue name="DespawnLootboxes" instantiate="true" checkinterval="10s">
					<conditions>
						<check_age min="global.$GB_Vault.$DespawnLootboxes" />
						<check_value value="global.$GB_Vault.$LootboxDrops.keys.list.count gt 0" />
					</conditions>
					<actions>
						<set_value name="global.$GB_Vault.$DespawnLootboxes" exact="player.age + 120s" />
						<do_for_each name="$drop" in="global.$GB_Vault.$LootboxDrops.keys.list">
							<do_if value="$drop.exists and global.$GB_Vault.$LootboxDrops.{$drop} - player.age gt 24h">
								<destroy_object object="$drop" />
								<remove_value name="global.$GB_Vault.$LootboxDrops.{$drop}" />
							</do_if>
						</do_for_each>
					</actions>
				</cue>


				<cue name="LoanPayment" instantiate="true" checkinterval="10s">
					<conditions>
						<check_age min="global.$GB_Vault.$NextPayment" />
					</conditions>
					<actions>
						<set_value name="global.$GB_Vault.$NextPayment" exact="player.age + global.$GB_Vault.$PaymentInterval" />
						<do_for_each name="$faction" in="global.$GB_Vault.$Accounts.keys.list">
							<set_value name="$Account" exact="global.$GB_Vault.$Accounts.{$faction}" />
							<set_value name="$AccountBalance" exact="$Account.$balance" />
							<set_value name="$LoanBalance" exact="$Account.$loan_balance" />
							<set_value name="$PaymentsMissed" exact="$Account.$paymentsMissed" />
							<set_value name="$Payment" exact="$Account.$payment" />
							<do_if value="$Payment gt 0">
								<do_if value="$AccountBalance lt $Payment
									or
									(
										$Payment gt $LoanBalance
										and
										$AccountBalance lt $LoanBalance
									)">
									<show_help force="true" duration="8s"
										custom="'You have received a Priority Message from '+$faction.name" position="20" />
									<set_value name="$Account.$arrears" operation="add" exact="$Payment" />
									<show_notification text="$faction+' Not enough funds for loan payment.'" />
									<set_value name="$text" exact="'Your loan payment with '+$faction.name+' failed due to not enough funds in your account.\n\n'+
										($Payment)i+'Cr is past due. Please make a manual payment of '+$Account.$arrears+'Cr.'" />

									<set_value name="$Account.$paymentsMissed" operation="add" exact="1" />
									<do_if value="$PaymentsMissed == 5">
										<set_value name="$text" operation="add" exact="'\n\nYou have missed 5 payments. Thus, your collateral is now subject to confiscation.'" />
									</do_if>
									<do_elseif value="$PaymentsMissed gt 5">
										<set_value name="$text" operation="add" exact="'\n\nReminder: Your collateral is subject to confiscation.'" />
									</do_elseif>
									<write_incoming_message highpriority="true"
										source="$faction.name"
										title="'Missed Loan Payment'"
										text="$text" />
									<add_faction_relation faction="$faction" otherfaction="faction.player" value="-0.001* if $PaymentsMissed gt 5 then 5 else $PaymentsMissed" reason="relationchangereason.missionfailed" />
								</do_if>
								<do_else>
									<do_if value="$Payment ge $LoanBalance">
										<set_value name="$Account.$balance" operation="subtract" exact="$LoanBalance" />
										<set_value name="$Account.$loan_balance" exact="0" />
										<set_value name="$Account.$payment" exact="0" />
										<show_notification text="$faction+' Loan Paid-off: '+$money" />
									</do_if>
									<do_else>
										<set_value name="$Account.$balance" operation="subtract" exact="$Payment" />
										<set_value name="$Account.$loan_balance" operation="subtract" exact="$Payment" />
										<show_notification text="$faction+' Loan Payment: '+$money" />
									</do_else>
								</do_else>
								<!-- full gain at 1m Cr -->
								<do_if value="$AccountBalance ge $Account.$maxRepCr*100">
									<add_faction_relation faction="$faction" otherfaction="faction.player" value="$Account.$paymentRepRate" reason="relationchangereason.missioncompleted" />
								</do_if>
								<do_elseif value="$AccountBalance gt 0">
									<add_faction_relation faction="$faction" otherfaction="faction.player" value="$Account.$paymentRepRate * $Account.$maxRepCr*100" reason="relationchangereason.missioncompleted" />
								</do_elseif>
							</do_if>
						</do_for_each>
					</actions>
				</cue>
			</cues>
		</cue>
	</cues>
</mdscript>
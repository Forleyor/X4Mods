<?xml version="1.0" encoding="utf-8"?>
<diff xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../xsd/mddiff.xsd">


  <add sel="//set_value[@name='$PreferredSectors']" pos="after">
    <!-- BEGIN Banking Clan's Vault -->
    <do_if value="$Faction == faction.bankingclan">
      <set_value name="$DebugChance" exact="global.$GB_Vault.$debug" />

      <debug_text text="'begin bankingclan stations'" chance="$DebugChance" />
      <set_value name="$set" exact="null" />
      <set_value name="$StationDefinitions" exact="[]" />

      <find_station_by_true_owner name="$hq"
        macro="macro.station_bankingclan_mainvault_macro"
        faction="faction.bankingclan" space="player.galaxy" />
      <do_if value="$hq" chance="$DebugChance">
        <debug_text text="'found operational hq: '+$hq.sector.name" />
      </do_if>
      <do_if value="$hq == null">
        <find_station_by_true_owner name="$hq"
          macro="macro.station_bankingclan_mainvault_macro" checkoperational="false"
          faction="faction.bankingclan" space="player.galaxy" state="componentstate.construction" />
        <do_if value="$hq" chance="$DebugChance">
          <debug_text text="'found construction hq: '+$hq.sector.name" />
        </do_if>
        <do_else>
          <debug_text text="'no hq found'" />
        </do_else>
      </do_if>
      <do_if value="$hq == null">
        <set_value name="$set" exact="'mainvault'" />
        <set_value name="$tag" exact="tag.mainvault" />
        <set_value name="$StationMacro" exact="[macro.station_bankingclan_mainvault_macro]" />
        <find_sector name="$sector" macro="macro.swi_clusterscipio_sector001_macro" />
        <do_if value="$sector.owner.relationto.{faction.bankingclan} ge 0.01">
          <set_value name="$PreferredSectors" exact="[$sector]" />
          <debug_text text="'found PreferredSector : '+$sector.name" chance="$DebugChance" />
        </do_if>
        <do_else>
          <set_value name="$PreferredSectors" exact="[]" />
        </do_else>
        <!-- set relevant sectors -->
        <find_sector name="$RelevantSectors" multiple="true"
          owner="faction.galempire"
          space="player.galaxy" />
        <do_if value="$RelevantSectors.count == 0">
          <find_sector name="$RelevantSectors" multiple="true"
            owner="[faction.ascendancy, faction.newrepublic, faction.commerceguild, faction.corporate, faction.huttcartel, faction.anoat, faction.mandodw]"
            space="player.galaxy" />
        </do_if>
        <debug_text text="'found RelevantSectors for faction: '+$RelevantSectors.{1}.owner" chance="$DebugChance" />
      </do_if>
      <do_else>
        <find_station_by_true_owner name="$stations"
          macro="macro.station_bankingclan_branchvault_macro"
          faction="faction.bankingclan" space="player.galaxy" multiple="true" />
        <do_if value="$stations.count gt 0">
          <set_value name="$text" exact="''" />
          <do_for_each name="$station" in="$stations" chance="$DebugChance">
            <set_value name="$text" exact="$text+' | '+$station.sector.owner+': '+$station.name+' in '+$station.sector.name" />
          </do_for_each>
          <debug_text text="'found branches: '+$stations.count+' | '+$text" chance="$DebugChance" />
        </do_if>
        <do_else>
          <debug_text text="'found branches: '+$stations.count" chance="$DebugChance" />
        </do_else>
        <find_station_by_true_owner name="$stationsC" checkoperational="false"
          macro="macro.station_bankingclan_branchvault_macro" state="componentstate.construction"
          faction="faction.bankingclan" space="player.galaxy" multiple="true" />
        <do_if value="$stationsC.count gt 0">
          <set_value name="$text" exact="''" />
          <do_for_each name="$station" in="$stationsC" chance="$DebugChance">
            <set_value name="$text" exact="$text+' | '+$station.sector.owner+': '+$station.name+' in '+$station.sector.name" />
          </do_for_each>
          <debug_text text="'found constructing branches: '+$stationsC.count+' | '+$text" chance="$DebugChance" />
        </do_if>
        <do_else>
          <debug_text text="'found branches: '+$stationsC.count" chance="$DebugChance" />
        </do_else>
        <set_value name="$templist" exact="global.$GB_Vault.$MajorFactionList.keys.list" />
        <set_value name="$factionlist" exact="$templist.clone" />
        <do_for_each name="$faction" in="$templist">
          <do_if value="not $faction.isactive">
            <remove_from_list name="$factionlist" exact="$faction" />
            <remove_value name="global.$GB_Vault.$MajorFactionList.{$faction}" />
          </do_if>
        </do_for_each>
        <do_all exact="$stations.count" counter="$i">
          <do_if value="$factionlist.indexof.{$stations.{$i}.sector.owner}">
            <remove_from_list name="$factionlist" exact="$stations.{$i}.sector.owner" />
          </do_if>
          <do_if value="$factionlist.count == 0">
            <break />
          </do_if>
        </do_all>
        <do_if value="$factionlist.count gt 0">
          <do_all exact="$stationsC.count" counter="$i">
            <do_if value="$factionlist.indexof.{$stationsC.{$i}.sector.owner}">
              <remove_from_list name="$factionlist" exact="$stationsC.{$i}.sector.owner" />
            </do_if>
            <do_if value="$factionlist.count == 0">
              <break />
            </do_if>
          </do_all>
        </do_if>
        <debug_text text="'factionlist: '+$factionlist" chance="$DebugChance" />
        <do_if value="$factionlist.count gt 0 and not ($factionlist == null)">
          <set_value name="$set" exact="'branchvault'" />
          <set_value name="$tag" exact="tag.branchvault" />
          <set_value name="$StationMacro" exact="[macro.station_bankingclan_branchvault_macro]" />
          <set_value name="$relevantFaction" exact="$factionlist.random" />
          <do_if value="$relevantFaction">
            <debug_text text="'factions missing branches: '+$factionlist+' | '+$relevantFaction" chance="$DebugChance" />
            <!-- set preferred sector -->
            <set_value name="$PreferredSectors" exact="[$relevantFaction.headquarters.sector]" />
            <debug_text text="'found PreferredSector: '+$relevantFaction+': '+$PreferredSectors.{1}.name" chance="$DebugChance" />
            <do_if value="not ($PreferredSectors.{1}.owner == $relevantFaction)">
              <debug_text text="'PreferredSector not owned by faction. owner: '+$PreferredSectors.{1}.owner" chance="$DebugChance" />
              <set_value name="$PreferredSectors" exact="[]" />
            </do_if>
            <!-- set relevant sectors, prefer non-border and not contested sectors -->
            <find_sector name="$RelevantSectors" multiple="true"
              owner="$relevantFaction"
              space="player.galaxy">
              <match locationtag="[tag.border]" negate="true" />
              <match contested="false" />
            </find_sector>
            <!-- <do_if value="not $RelevantSectors? or $RelevantSectors == []">
              <find_sector name="$RelevantSectors" multiple="true"
                owner="$relevantFaction"
                space="player.galaxy" />
            </do_if> -->
            <debug_text text="'found RelevantSectors: '+$RelevantSectors" chance="$DebugChance" />
          </do_if>
        </do_if>
      </do_else>

      <do_if value="not ($set == null) and (not ($RelevantSectors == null) or $RelevantSectors.count gt 0)">
        <get_module_set_macro set="$set" result="$ModuleSetMacro" />
        <debug_text text="'found ModuleSetMacro: '+$set" chance="$DebugChance" />
        <do_if value="$ModuleSetMacro">
          <get_construction_plan result="$ConstructionPlan"
            rawname="$ConstructionPlanName"
            faction="$Faction" tags="$tag" />
          <debug_text text="'found '+$ConstructionPlanName+': '+$ConstructionPlan" chance="$DebugChance" />
        </do_if>

        <do_if value="$PastStationMaxScoreTableOverrides.$IsTradeStation?">
          <set_value name="$PastStationMaxScoreTable"
            exact="$PastStationMaxScoreTableOverrides.$IsTradeStation" />
        </do_if>
        <do_else>
          <!--Default table-->
          <set_value name="$PastStationMaxScoreTable"
            exact="table[
                               $WasTradeStation = 1.0f,
                               $WasEquipmentDock = 0.25f,
                               $WasShipyard = 0.25f,
                               $WasWharf = 0.25f]" />
        </do_else>

        <debug_text text="'Macro '+$StationMacro.count" chance="$DebugChance" />

        <do_if value="$StationMacro.count gt 0">
          <debug_text text="'Building '+$StationMacro" chance="$DebugChance" />

          <run_actions ref="Find_Location_And_Build_Station" result="$NewStations">
            <!--Faction params-->
            <!-- Galactic Bank claimedsectors equals all relevant sectors -->
            <param name="Faction" value="$Faction" />
            <param name="StationHistory" value="$StationHistory" />
            <param name="RelevantSectors" value="$RelevantSectors" />
            <param name="ClaimedSectors" value="$RelevantSectors" />
            <param name="PreferredSectors" value="$PreferredSectors" />

            <!--Station params-->
            <param name="NumStations" value="1" />
            <param name="StationDefinitions" value="$StationMacro" />
            <param name="ModuleSetMacro" value="$ModuleSetMacro" />
            <!--TODO @Owen base the loadout level on the sector / station type-->
            <param name="LoadoutLevel" value="1" />

            <!--Station history analysis-->
            <param name="ExistingStationValName" value="'$IsTradeStation'" />
            <param name="PastStationValName" value="'$WasTradeStation'" />
            <param name="PastStationMaxScoreTable" value="$PastStationMaxScoreTable" />

            <param name="DebugText" value="$DebugText" />
            <param name="DebugChance" value="$DebugChance" />
          </run_actions>
        </do_if>
      </do_if>
    </do_if>
    <do_else>
      <set_value name="$DebugChance" exact="0" />
    </do_else>
    <!-- END Banking Clan's Vault -->
  </add>
</diff>
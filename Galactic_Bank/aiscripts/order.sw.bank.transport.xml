<?xml version="1.0" encoding="utf-8"?>
<aiscript name="order.sw.bank.transport" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../xsd/aiscripts.xsd" version="2">
  <order id="SWBankTransport" name="{20777, 1001} {20777, 1005} {20777, 1008}" description="{20777, 1012}" category="internal" allowinloop="false" infinite="true">
    <params>
      <param name="debugchance" type="bool" default="0" advanced="true" text="{1041, 10086}" comment="Print debug output">
        <input_param name="truevalue" value="100" />
      </param>
    </params>
  </order>

  <interrupts>
    <handler ref="SectorChangeHandler" />
    <handler ref="AttackHandler" />
    <handler ref="MissileLockHandler" />
    <handler ref="ScannedHandler" />
    <handler ref="InspectedHandler" />
    <handler ref="ResupplyHandler" />
    <handler comment="unable to continue. finish.">
      <conditions>
        <event_object_changed_true_owner object="this.ship" check="false" />
      </conditions>
      <actions>
        <debug_text text="'unable to continue. event: %s. cleaning up.'.[event.name]" chance="$debugchance" />
        <abort_called_scripts resume="finish" />
      </actions>
    </handler>
  </interrupts>

  <init>

  </init>

  <attention min="unknown">
    <actions>
      <label name="init" />
      <do_if value="not this.ship.exists">
        <debug_text text="'waiting to exist: '+this.name" />
        <wait exact="30s" resume="true" />
        <debug_text text="'resuming to exist'" />
        <resume label="init" />
      </do_if>
      <debug_text text="'starting new route from '+this.sector.name" />
      <find_station_by_true_owner name="$stations" multiple="true"
        macro="macro.station_bankingclan_branchvault_macro"
        faction="faction.bankingclan" space="player.galaxy" />
      <debug_text text="'found operational branches: '+$stations.count+' stationslist: '+$stations" />
      <find_station_by_true_owner name="$stationsC" multiple="true" checkoperational="false"
        macro="macro.station_bankingclan_branchvault_macro" state="componentstate.construction"
        faction="faction.bankingclan" space="player.galaxy" />
      <do_if value="$stationsC.count gt 0">
        <append_to_list name="$stations" exact="$stationsC" />
        <debug_text text="'found constructing branches: '+$stationsC.count+' stationslist: '+$stationsC" />
      </do_if>
      <find_station_by_true_owner name="$hq" multiple="true"
        macro="macro.station_bankingclan_mainvault_macro"
        faction="faction.bankingclan" space="player.galaxy" />
      <do_if value="$hq.count gt 0">
        <append_to_list name="$stations" exact="$hq" />
        <debug_text text="'found operational hq: '+$hq.count+' stationslist: '+$hq" />
      </do_if>
      <do_else>
        <find_station_by_true_owner name="$hqC" multiple="true" checkoperational="false"
          macro="macro.station_bankingclan_mainvault_macro" state="componentstate.construction"
          faction="faction.bankingclan" space="player.galaxy" />
        <do_if value="$hqC.count gt 0">
          <append_to_list name="$stations" exact="$hqC" />
          <debug_text text="'found constructing hq: '+$hqC.count+' stationslist: '+$hqC" />
        </do_if>
      </do_else>
      <debug_text text="'found stations: '+$stations.count+' stationslist: '+$stations" />
      <do_if value="$stations == null or $stations.count lt 2">
        <debug_text text="'waiting for stations'" />
        <wait exact="1m" resume="true" />
        <debug_text text="'resuming for stations'" />
        <resume label="init" />
      </do_if>
      <set_value name="$stationA" exact="$stations.random" />
      <remove_from_list name="$stations" exact="$stationA" />
      <set_value name="$stationB" exact="$stations.random" />
      <set_value name="$currentStation" exact="$stationA" />

      <label name="continueRoute" />
      <debug_text text="'continueRoute between: '+$stationA+' and '+$stationB+' next: '+$currentStation" />

      <!-- Travel to the station -->
      <move_to travel="true" object="this.assignedcontrolled" destination="$currentStation" />

      <run_script name="'order.dock'" result="$docked">
        <param name="destination" value="$currentStation" />
        <param name="dockfollowers" value="true" />
        <param name="noattackresponse" value="true" />
        <param name="internalorder" value="true" />
      </run_script>
      <do_if value="$docked">
        <debug_text text="'docked'" />
        <wait min="1m" max="9m" resume="true" />
      </do_if>
      <undock ship="this.assignedcontrolled" />
      <debug_text text="'undocked'" />

      <!-- Change Route? -->
      <set_value name="$changeRoute" exact="false" />
      <set_value name="$changeRoute" exact="true" chance="10" />
      <do_if value="$changeRoute">
        <set_value name="$changeRoute" exact="false" />
        <resume label="init" />
      </do_if>

      <do_else>
        <!-- Toggle destination -->
        <debug_text text="'toggle destination'" />
        <do_if value="$currentStation == $stationA">
          <set_value name="$currentStation" exact="$stationB" />
        </do_if>
        <do_else>
          <set_value name="$currentStation" exact="$stationA" />
        </do_else>

        <!-- Verify destination -->
        <find_station_by_true_owner name="$check" faction="faction.bankingclan" space="$currentStation.sector" functional="true" />
        <do_if value="$check">
          <debug_text text="'destination found'" />
          <resume label="continueRoute" />
        </do_if>
        <do_else>
          <debug_text text="'destination destroyed'" />
          <resume label="init" />
        </do_else>
      </do_else>

      <resume label="init" />
      <label name="finish" />
      <set_order_syncpoint_reached order="this.assignedcontrolled.order" />

    </actions>
  </attention>

  <on_abort>
    <do_if value="this.assignedcontrolled.isoperational and this.assignedcontrolled.trueowner == faction.bankingclan">
      <create_order object="this.assignedcontrolled" id="'SWBankTransport'" default="true" />
    </do_if>
  </on_abort>
</aiscript>